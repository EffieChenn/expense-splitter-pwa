<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ÊÉÖ‰æ∂Â∏≥ÂñÆÂàÜÂ∏≥ App</title>
    <!-- ÂºïÂÖ• Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ÂºïÂÖ• React & ReactDOM -->
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    ></script>
    <!-- ÂºïÂÖ• Babel Áî®ÊñºËß£Êûê JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- ‰øÆÊ≠£: È°ØÂºèÂºïÂÖ• Prop-TypesÔºåËß£Ê±∫ Recharts ‰æùË≥¥ÂïèÈ°å -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <!-- ÂºïÂÖ• Recharts -->
    <script src="https://cdn.jsdelivr.net/npm/recharts@2.12.7/umd/Recharts.min.js"></script>

    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        background-color: #f2f2f7;
      }
      /* Èö±ËóèÊªæÂãïÊ¢ù‰ΩÜ‰øùÁïôÂäüËÉΩ */
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
    </style>

    <!-- Firebase SDK ÂàùÂßãÂåñ (Module) -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        onAuthStateChanged,
        signInWithCustomToken,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        query,
        onSnapshot,
        serverTimestamp,
        doc,
        deleteDoc,
        orderBy,
        runTransaction,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      // Â∞á Firebase ÂáΩÂºèÊéõËºâÂà∞ window ‰ª•‰æø Babel ËÖ≥Êú¨‰ΩøÁî®
      window.FirebaseServices = {
        initializeApp,
        getAuth,
        signInAnonymously,
        onAuthStateChanged,
        signInWithCustomToken,
        getFirestore,
        collection,
        addDoc,
        query,
        onSnapshot,
        serverTimestamp,
        doc,
        deleteDoc,
        orderBy,
        runTransaction,
      };
    </script>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      // ==========================================
      // 1. Ë®≠ÂÆöÂçÄÂüü (Ë´ãÂú®Ê≠§Â°´ÂÖ•ÊÇ®ÁöÑË≥áÊñô)
      // ==========================================

      // ÊÇ®ÁöÑ Firebase Config
      const FIREBASE_CONFIG = {
        apiKey: "AIzaSyCYYWwtVnJ4Duo4R6TeV5z6oYGS-2_2Ug8",
        authDomain: "expense-splitter-pwa.firebaseapp.com",
        projectId: "expense-splitter-pwa",
        storageBucket: "expense-splitter-pwa.firebasestorage.app",
        messagingSenderId: "355640730128",
        appId: "1:355640730128:web:b8a64a1a35f7957b05a095",
      };

      // ÊÇ®ÁöÑ Gemini API Key
      const GEMINI_API_KEY = "AIzaSyCk1bHPtjg2DX_n3J_JLgTZy_tdC0dK26E"; // <-- Ë´ãÊõøÊèõ

      // App ID (Áî®ÊñºË≥áÊñôÂ∫´Ë∑ØÂæëÈöîÈõ¢ÔºåÂèØ‰øùÊåÅ‰∏çËÆä)
      const APP_NAMESPACE_ID = "standalone-couple-expense-app";

      // ==========================================
      // 2. ÂúñÁ§∫ÂÖÉ‰ª∂ (Inline SVG - Á¢∫‰øùÁ©©ÂÆöÊÄß)
      // ==========================================
      const IconBase = ({ children, className = "", ...props }) => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
          className={className}
          {...props}
        >
          {children}
        </svg>
      );

      const CreditCard = (props) => (
        <IconBase {...props}>
          <rect width="20" height="14" x="2" y="5" rx="2" />
          <line x1="2" x2="22" y1="10" y2="10" />
        </IconBase>
      );
      const User = (props) => (
        <IconBase {...props}>
          <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" />
          <circle cx="12" cy="7" r="4" />
        </IconBase>
      );
      const Users = (props) => (
        <IconBase {...props}>
          <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
          <circle cx="9" cy="7" r="4" />
          <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
          <path d="M16 3.13a4 4 0 0 1 0 7.75" />
        </IconBase>
      );
      const Heart = (props) => (
        <IconBase {...props}>
          <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />
        </IconBase>
      );
      const Check = (props) => (
        <IconBase {...props}>
          <polyline points="20 6 9 17 4 12" />
        </IconBase>
      );
      const X = (props) => (
        <IconBase {...props}>
          <path d="M18 6 6 18" />
          <path d="m6 6 12 12" />
        </IconBase>
      );
      const Plus = (props) => (
        <IconBase {...props}>
          <path d="M5 12h14" />
          <path d="M12 5v14" />
        </IconBase>
      );
      const PieIcon = (props) => (
        <IconBase {...props}>
          <path d="M21.21 15.89A10 10 0 1 1 8 2.83" />
          <path d="M22 12A10 10 0 0 0 12 2v10z" />
        </IconBase>
      );
      const ArrowLeftRight = (props) => (
        <IconBase {...props}>
          <path d="M8 3 4 7l4 4" />
          <path d="M4 7h16" />
          <path d="m16 21 4-4-4-4" />
          <path d="M20 17H4" />
        </IconBase>
      );
      const Settings = (props) => (
        <IconBase {...props}>
          <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
          <circle cx="12" cy="12" r="3" />
        </IconBase>
      );
      const Wallet = (props) => (
        <IconBase {...props}>
          <path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h18a2 2 0 0 1 0 4h-5m-9 3a2 2 0 0 0 0 4h14a2 2 0 0 0 0-4h-2M8 12h.01" />
        </IconBase>
      );
      const FileText = (props) => (
        <IconBase {...props}>
          <path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z" />
          <path d="M14 2v4a2 2 0 0 0 2 2h4" />
          <path d="M10 9H8" />
          <path d="M16 13H8" />
          <path d="M16 17H8" />
        </IconBase>
      );
      const Calendar = (props) => (
        <IconBase {...props}>
          <path d="M8 2v4" />
          <path d="M16 2v4" />
          <rect width="18" height="18" x="3" y="4" rx="2" />
          <path d="M3 10h18" />
        </IconBase>
      );
      const Trash2 = (props) => (
        <IconBase {...props}>
          <path d="M3 6h18" />
          <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
          <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
          <line x1="10" x2="10" y1="11" y2="17" />
          <line x1="14" x2="14" y1="11" y2="17" />
        </IconBase>
      );
      const Loader = (props) => (
        <IconBase {...props}>
          <path d="M21 12a9 9 0 1 1-6.219-8.56" />
        </IconBase>
      );
      const Sparkles = (props) => (
        <IconBase {...props}>
          <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" />
          <path d="M5 3v4" />
          <path d="M9 3v4" />
          <path d="M3 7h4" />
          <path d="M3 5h4" />
        </IconBase>
      );
      const MessageSquareQuote = (props) => (
        <IconBase {...props}>
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
          <path d="M8 12a2 2 0 0 0 2-2V8H8" />
          <path d="M14 12a2 2 0 0 0 2-2V8h-2" />
        </IconBase>
      );
      const Copy = (props) => (
        <IconBase {...props}>
          <rect width="14" height="14" x="8" y="8" rx="2" ry="2" />
          <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" />
        </IconBase>
      );
      const Wand2 = (props) => (
        <IconBase {...props}>
          <path d="m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72Z" />
          <path d="m14 7 3 3" />
          <path d="M5 6v4" />
          <path d="M19 14v4" />
          <path d="M10 2v2" />
          <path d="M7 8H3" />
          <path d="M21 16h-4" />
          <path d="M11 3H9" />
        </IconBase>
      );

      // ==========================================
      // 3. ÊáâÁî®Á®ãÂºèÈÇèËºØ (React App)
      // ==========================================

      const { useState, useMemo, useEffect } = React;

      // ‰øÆÊ≠£ 2: ÈÄôË£°‰∏çÂÜçËß£Êßã Recharts ÁöÑÁµÑ‰ª∂ÔºåÂõ†ÁÇ∫ÂÆÉÂèØËÉΩÂú® Babel Âü∑Ë°åÊôÇÈÇÑÊú™ÂÆåÂÖ®Â∞±Á∑í„ÄÇ
      // ÊàëÂÄëÂ∞á Recharts ÁöÑÁµÑ‰ª∂ËÆäÊï∏ÂÆöÁæ©ÁßªÂà∞ÁµÑ‰ª∂ÂÖßÈÉ®ÊàñÁ¢∫‰øùÂÆÉÊòØÂÖ®ÂüüÂèØÁî®„ÄÇ
      const RechartsComponents = window.Recharts || {};
      const { PieChart, Pie, Cell, ResponsiveContainer, Legend, Tooltip } =
        RechartsComponents;

      // Âæû window Áç≤Âèñ Firebase Ê®°ÁµÑ
      const {
        initializeApp,
        getAuth,
        signInAnonymously,
        onAuthStateChanged,
        getFirestore,
        collection,
        addDoc,
        query,
        onSnapshot,
        serverTimestamp,
        doc,
        deleteDoc,
        orderBy,
        runTransaction,
      } = window.FirebaseServices;

      const PIE_COLORS = [
        "#FF9500",
        "#AF52DE",
        "#007AFF",
        "#FF2D55",
        "#5856D6",
        "#8E8E93",
        "#34C759",
      ];
      const currentYear = new Date().getFullYear();
      // ÈÄôË£°ÈúÄË¶ÅÁ¢∫‰øùÂú® React ÂÖßÈÉ®‰ΩøÁî®ÊôÇ key ÊòØÂ∑≤Á∂ìÂ°´ÂØ´ÁöÑ
      // ÊàëÂÄëÂ∞á URL Âª∫ÊßãÁßªÂà∞ callGemini ÂÖßÈÉ®

      const classifyCategory = (merchant) => {
        let cat = "ÂÖ∂‰ªñ";
        const m = merchant;
        if (
          m.includes("Uber") ||
          m.includes("È∫•Áï∂Âãû") ||
          m.includes("È§ê") ||
          m.includes("È£ü") ||
          m.includes("È£≤Êñô") ||
          m.includes("Ë∑ØÊòìËéé") ||
          m.includes("ÊòüÂ∑¥ÂÖã")
        )
          cat = "È§êÈ£≤";
        else if (
          m.includes("ÂÖ®ËÅØ") ||
          m.includes("ÂÆ∂Ê®ÇÁ¶è") ||
          m.includes("ÂØ∂ÈõÖ") ||
          m.includes("Â∫∑ÊòØÁæé") ||
          m.includes("Ë∂ÖÂ∏Ç") ||
          m.includes("Â±àËá£Ê∞è")
        )
          cat = "Â±ÖÂÆ∂";
        else if (
          m.includes("ÂÆ¢ÈÅã") ||
          m.includes("È´òÈêµ") ||
          m.includes("Ëªä") ||
          m.includes("Âä†Ê≤π") ||
          m.includes("Êç∑ÈÅã") ||
          m.includes("ÊÇ†ÈÅäÂç°") ||
          m.includes("Line Taxi")
        )
          cat = "‰∫§ÈÄö";
        else if (
          m.includes("Netflix") ||
          m.includes("Spotify") ||
          m.includes("Â•ΩÊ®ÇËø™") ||
          m.includes("ÈõªÂΩ±") ||
          m.includes("Èå¢Ê´É") ||
          m.includes("Steam")
        )
          cat = "Â®õÊ®Ç";
        else if (
          m.includes("Uniqlo") ||
          m.includes("Zara") ||
          m.includes("Ë°£") ||
          m.includes("ÊúçÈ£æ") ||
          m.includes("Èûã") ||
          m.includes("GU")
        )
          cat = "Ë≥ºÁâ©";
        return cat;
      };

      const callGemini = async (prompt) => {
        if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY") {
          return "ÈåØË™§ÔºöË´ãÂÖàÂú® index.html Á®ãÂºèÁ¢º‰∏≠Â°´ÂÖ•ÊÇ®ÁöÑ GEMINI_API_KEY„ÄÇ";
        }
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;

        try {
          const response = await fetch(GEMINI_API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
          });

          if (!response.ok)
            throw new Error(`API call failed: ${response.status}`);
          const data = await response.json();
          return (
            data.candidates?.[0]?.content?.parts?.[0]?.text ||
            "AI Êö´ÊôÇÁÑ°Ê≥ïÂõûÊáâÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ"
          );
        } catch (error) {
          console.error("Gemini API Error:", error);
          return "ÈÄ£Á∑öÁôºÁîüÂïèÈ°åÔºåÁÑ°Ê≥ïÁî¢ÁîüÂÖßÂÆπ„ÄÇ";
        }
      };

      function ExpenseSplitterApp() {
        // Á¢∫Ë™ç Recharts ÂÖÉ‰ª∂ÊòØÂê¶ÂèØÁî®
        const isRechartsReady = !!PieChart;

        const [activeTab, setActiveTab] = useState("swipe");
        const [queue, setQueue] = useState([]);
        const [history, setHistory] = useState([]);
        const [showImportModal, setShowImportModal] = useState(false);
        const [showManualModal, setShowManualModal] = useState(false);

        const [manualForm, setManualForm] = useState({
          merchant: "",
          amount: "",
          type: "shared",
        });
        const [rawInput, setRawInput] = useState("");
        const [cardNameInput, setCardNameInput] = useState("");
        const [chartView, setChartView] = useState("personal");

        // --- AI State ---
        const [aiMessage, setAiMessage] = useState("");
        const [isAiLoading, setIsAiLoading] = useState(false);
        const [showAiModal, setShowAiModal] = useState(false);
        const [aiInsight, setAiInsight] = useState("");
        const [isInsightLoading, setIsInsightLoading] = useState(false);

        // --- Firebase State ---
        const [db, setDb] = useState(null);
        const [auth, setAuth] = useState(null);
        const [user, setUser] = useState(null);
        const appId = APP_NAMESPACE_ID;

        // --- Date Filter State ---
        const today = new Date();
        const currentMonthKey = `${today.getFullYear()}-${String(
          today.getMonth() + 1
        ).padStart(2, "0")}`;
        const [selectedMonthKey, setSelectedMonthKey] =
          useState(currentMonthKey);
        const [availableMonths, setAvailableMonths] = useState([
          currentMonthKey,
        ]);

        // --- 1. Initialize Firebase & Auth ---
        useEffect(() => {
          if (
            !FIREBASE_CONFIG.apiKey ||
            FIREBASE_CONFIG.apiKey === "YOUR_FIREBASE_API_KEY"
          ) {
            alert("Ë´ãÂÖàÂú® index.html Á®ãÂºèÁ¢º‰∏≠Â°´ÂØ´ FIREBASE_CONFIGÔºÅ");
            return;
          }

          try {
            const app = initializeApp(FIREBASE_CONFIG);
            const authInstance = getAuth(app);
            const dbInstance = getFirestore(app);

            setAuth(authInstance);
            setDb(dbInstance);

            const initAuth = async () => {
              await signInAnonymously(authInstance);
            };
            initAuth();

            const unsubscribe = onAuthStateChanged(authInstance, (u) => {
              setUser(u);
            });
            return () => unsubscribe();
          } catch (e) {
            console.error("Firebase Init Error:", e);
            alert("Firebase ÂàùÂßãÂåñÂ§±ÊïóÔºåË´ãÊ™¢Êü• Config");
          }
        }, []);

        // --- 2. Data Sync (Firestore -> History) ---
        useEffect(() => {
          if (!user || !db) return;

          // ÁÇ∫‰∫ÜÁ∞°ÂñÆËµ∑Ë¶ãÔºåÂú®Áç®Á´ã App ‰∏≠ÊàëÂÄë‰ΩøÁî® users/{uid}/expenses
          // ÈÄôÊ®£ÂèØ‰ª•Á¢∫‰øùË≥áÊñôÊòØË∑üËëó‰ΩøÁî®ËÄÖÁöÑ (ÂåøÂêçÁôªÂÖ•‰∏ãÔºåËã•Ê∏ÖÈô§ cookies ÂèØËÉΩÊúÉÈÅ∫Â§±ÔºåÂª∫Ë≠∞ÂØ¶‰ΩúÁôªÂÖ•Ôºå‰ΩÜÈÄôË£°ÂÖà‰øùÊåÅÂåøÂêç)
          const q = query(
            collection(db, "artifacts", appId, "users", user.uid, "expenses")
          );

          const unsubscribe = onSnapshot(
            q,
            (snapshot) => {
              const docs = snapshot.docs.map((doc) => ({
                id: doc.id,
                ...doc.data(),
              }));

              docs.sort((a, b) => {
                const dateA = new Date(a.date).getTime();
                const dateB = new Date(b.date).getTime();
                return dateB - dateA;
              });

              setHistory(docs);

              const months = new Set(
                docs.map((d) => d.monthKey).filter(Boolean)
              );
              if (!months.has(currentMonthKey)) months.add(currentMonthKey);
              setAvailableMonths(Array.from(months).sort().reverse());
            },
            (error) => {
              console.error("Data sync error:", error);
            }
          );

          return () => unsubscribe();
        }, [user, db, appId, currentMonthKey]);

        // --- Actions ---
        const handleSwipe = async (item, type) => {
          if (!user || !db) return;

          const classifiedItem = {
            ...item,
            type,
            monthKey: item.date.substring(0, 7).replace(/\//g, "-"), // YYYY-MM
            timestamp: serverTimestamp(),
            userId: user.uid,
          };

          try {
            await addDoc(
              collection(db, "artifacts", appId, "users", user.uid, "expenses"),
              classifiedItem
            );
            setQueue((prev) => prev.filter((i) => i.id !== item.id));
          } catch (e) {
            console.error("Save error:", e);
            alert("ÂÑ≤Â≠òÂ§±ÊïóÔºåË´ãÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Á∑ö");
          }
        };

        const handleDelete = async (itemId) => {
          if (!user || !db) return;
          // ‰ΩøÁî®Ëá™ÂÆöÁæ©ÁöÑ modal ÊõøÊèõ confirm()
          if (window.confirm("Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠ÜÁ¥ÄÈåÑÂóéÔºü")) {
            try {
              await deleteDoc(
                doc(
                  db,
                  "artifacts",
                  appId,
                  "users",
                  user.uid,
                  "expenses",
                  itemId
                )
              );
            } catch (e) {
              console.error("Delete error:", e);
            }
          }
        };

        const copyToClipboard = (text) => {
          const tempTextarea = document.createElement("textarea");
          tempTextarea.value = text;
          tempTextarea.style.position = "absolute";
          tempTextarea.style.left = "-9999px";
          document.body.appendChild(tempTextarea);

          let copySuccess = false;
          try {
            tempTextarea.select();
            // navigator.clipboard.writeText is preferred, but execCommand is safer in some iFrame environments
            copySuccess = document.execCommand("copy");
          } catch (err) {
            console.error("Ë§áË£ΩÂ§±Êïó:", err);
          } finally {
            document.body.removeChild(tempTextarea);
          }

          if (copySuccess) {
            // ‰ΩøÁî®Ëá™ÂÆöÁæ© modal/message ÊõøÊèõ alert()
            alert("Ë§áË£ΩÊàêÂäüÔºÅË∂ïÂø´ÂÇ≥Áµ¶‰ªñÂêß ‚ù§Ô∏è");
            setShowAiModal(false);
          } else {
            alert("Ë§áË£ΩÂ§±ÊïóÔºåÂèØËÉΩÊòØÁÄèË¶ΩÂô®Ê¨äÈôêÂïèÈ°åÔºåË´ãÊâãÂãïÈÅ∏ÂèñË®äÊÅØÂÖßÂÆπ„ÄÇ");
          }
        };

        // --- Gemini Features ---
        const generateSettlementMessage = async () => {
          setIsAiLoading(true);
          setShowAiModal(true);
          setAiMessage("");

          const halfShared = Math.round(summary.sharedTotal / 2);
          const prompt = `
                ‰Ω†ÊòØ‰∏Ä‰ΩçË≤ºÂøÉÁöÑÂ•≥ÂèãÔºåË¶ÅÂÇ≥Ë®äÊÅØÁµ¶Áî∑ÂèãÈÄ≤Ë°åÊú¨ÊúàÂ∏≥ÂãôÁµêÁÆó„ÄÇ
                Ë´ãÊ†πÊìö‰ª•‰∏ãÊï∏ÊìöÂØ´‰∏ÄÊÆµÁπÅÈ´î‰∏≠ÊñáË®äÊÅØÔºåË™ûÊ∞£Ë¶Å**ÂèØÊÑõ„ÄÅÊííÂ¨å„ÄÅÂèãÂñÑ**Ôºå‰∏çË¶ÅÂÉèË®éÂÇµÂÖ¨Âè∏„ÄÇ
                ÂèØ‰ª•Âä†‰∏Ä‰∫õË°®ÊÉÖÁ¨¶Ëôü (Emoji)„ÄÇ
                
                Ë≥áÊñôÂ¶Ç‰∏ãÔºö
                - Êúà‰ªΩÔºö${summary.monthLabel}
                - ÂÖ±ÂêåËä±Ë≤ªÁ∏ΩÈáëÈ°çÔºö${summary.sharedTotal.toLocaleString()} ÂÖÉ (ÊâÄ‰ª•‰∏Ä‰∫∫ÂàÜÊìî ${halfShared.toLocaleString()} ÂÖÉ)
                - ÊàëÂπ´‰Ω†‰ª£Â¢äÁöÑÂÄã‰∫∫Ëä±Ë≤ªÔºö${summary.forHimTotal.toLocaleString()} ÂÖÉ
                - **Áî∑ÂèãÁ∏ΩÂÖ±ÈúÄË¶ÅËΩâÁµ¶Êàë**Ôºö${summary.bfOwes.toLocaleString()} ÂÖÉ

                ÁµêÊßãÂª∫Ë≠∞Ôºö
                1. ÈñãÈ†≠ÂÖàÊííÂ¨å‰∏Ä‰∏ã„ÄÇ
                2. ÂàóÂá∫Ê∏ÖÊô∞ÁöÑÁÆóÂºè (ÂÖ±ÂêåÁöÑ‰∏ÄÂçä + ‰ª£Â¢ä = Á∏ΩÈ°ç)„ÄÇ
                3. ÊúÄÂæåÁµ¶‰∏ÄÂÄã‰ªòÊ¨æÁöÑ Call to Action (‰æãÂ¶ÇÔºöÂÜçÈ∫ªÁÖ©ÂØ∂Ë≤ùËΩâÂ∏≥Âõâ~)„ÄÇ
                `;

          const result = await callGemini(prompt);
          setAiMessage(result);
          setIsAiLoading(false);
        };

        const generateInsight = async () => {
          setIsInsightLoading(true);
          setAiInsight("");

          const topCategories = chartData
            .sort((a, b) => b.value - a.value)
            .slice(0, 3);
          const dataStr = topCategories
            .map((c) => `${c.name}: $${c.value}`)
            .join(", ");
          const total =
            chartView === "personal"
              ? summary.personalTotal
              : summary.sharedTotal;

          const prompt = `
                Ë´ãÊ†πÊìöÈÄôÂÄãÊúàÁöÑÊ∂àË≤ªÊï∏ÊìöÔºåÁµ¶Âá∫‰∏ÄÂè•**ÂπΩÈªò„ÄÅÊØíËàå‰ΩÜ‰∏≠ËÇØ**ÁöÑÁü≠Ë©ï (50Â≠ó‰ª•ÂÖß)„ÄÇ
                Â∞çË±°Ôºö${chartView === "personal" ? "ÊàëÂÄã‰∫∫" : "ÊàëÂÄëÊÉÖ‰æ∂ÂÄÜ"}
                Êúà‰ªΩÔºö${selectedMonthKey}
                Á∏ΩËä±Ë≤ªÔºö${total.toLocaleString()}
                Ââç‰∏âÂ§ßËä±Ë≤ªÈ°ûÂà•Ôºö${dataStr}

                Ë´ãÁî®ÁπÅÈ´î‰∏≠Êñá„ÄÇÂ¶ÇÊûúÊòØÈ§êÈ£≤Â§öÔºåÂèØ‰ª•Á¨ëÊàëÂÄëÂ§™ÊúÉÂêÉÔºõÂ¶ÇÊûúÊòØË≥ºÁâ©Â§öÔºåÂèØ‰ª•Á¨ëË¶ÅÂâÅÊâã‰∫Ü„ÄÇ
                `;

          const result = await callGemini(prompt);
          setAiInsight(result);
          setIsInsightLoading(false);
        };

        // --- Parsing Logic ---
        const parseBillText = () => {
          const lines = rawInput.split("\n");
          let rawItems = [];
          const finalCardName = cardNameInput.trim() || "ÂåØÂÖ•Â∏≥ÂñÆ";

          lines.forEach((line, idx) => {
            const trimmedLine = line.trim();
            if (!trimmedLine) return;

            let match = null;
            let date = "";
            let merchant = "";
            let amount = 0;
            let cardName = finalCardName;

            // Âè∞ÁÅ£‰ø°Áî®Âç°/Á∂≤ÈäÄÂ∏∏Ë¶ãÊ†ºÂºè
            const regexTypeA =
              /^(\d{2}\/\d{2})\s+\d{2}\/\d{2}\s+(.+?)\s+(-?[\d,]+)\s+\d{4}\s+TW\s+TWD$/;
            const regexTypeB =
              /^(\d{3}\/\d{2}\/\d{2})\s+(.*?)\s+(?:\d{3}\/\d{2}\/\d{2})\s+TWD\s+([-\d,]+)$/; // Ê∞ëÂúãÂπ¥
            const regexTypeC =
              /^(\d{3}\/\d{2}\/\d{2})\s+\d{3}\/\d{2}\/\d{2}\s+(.+?)\s+([-\d,]+)\s+TW$/; // Ê∞ëÂúãÂπ¥
            const regexCSV = /^([\d\/-]+)[,Ôºå](.+?)[,Ôºå]([-\d,]+).*$/;

            if ((match = trimmedLine.match(regexTypeA))) {
              date = `${currentYear}/${match[1]}`;
              merchant = match[2].trim();
              amount = parseFloat(match[3].replace(/,/g, ""));
            } else if ((match = trimmedLine.match(regexTypeB))) {
              const [y, m, d] = match[1].split("/");
              date = `${parseInt(y) + 1911}/${m}/${d}`; // Ê∞ëÂúãÂπ¥ËΩâË•øÂÖÉÂπ¥
              merchant = match[2].trim();
              amount = parseFloat(match[3].replace(/,/g, ""));
            } else if ((match = trimmedLine.match(regexTypeC))) {
              const [y, m, d] = match[1].split("/");
              date = `${parseInt(y) + 1911}/${m}/${d}`; // Ê∞ëÂúãÂπ¥ËΩâË•øÂÖÉÂπ¥
              merchant = match[2].trim();
              amount = parseFloat(match[3].replace(/,/g, ""));
            } else if ((match = trimmedLine.match(regexCSV))) {
              date = match[1].replace(/-/g, "/");
              merchant = match[2];
              amount = parseFloat(match[3].replace(/,/g, ""));
            }

            if (!isNaN(amount) && amount !== 0) {
              // ÊéíÈô§ÂàÜÊúü„ÄÅÂπ¥ÁôæÂàÜÁéáÁ≠âÈùûÂØ¶ÈöõÊ∂àË≤ªÈ†ÖÁõÆ
              if (
                !merchant.includes("Êú¨Á≠ÜÂàÜÊúü") &&
                !merchant.includes("Á∏ΩË≤ªÁî®Âπ¥ÁôæÂàÜÁéá")
              ) {
                rawItems.push({
                  id: Date.now() + idx + Math.random(),
                  date,
                  merchant,
                  amount,
                  card: cardName,
                  category: classifyCategory(merchant),
                });
              }
            }
          });

          // Deduplication Logic (Âêà‰ΩµÊäòÊäµ)
          const mergedItems = [];
          const usedOffsetIds = new Set();
          const positiveItems = rawItems.filter((i) => i.amount > 0);
          const negativeItems = rawItems.filter((i) => i.amount < 0);

          positiveItems.forEach((item) => {
            let finalAmount = item.amount;
            let totalDeduction = 0;
            let matched = false;

            negativeItems.forEach((offset) => {
              if (usedOffsetIds.has(offset.id)) return;
              const isOffsetType =
                offset.merchant.includes("ÊäòÊäµ") ||
                offset.merchant.includes("ÈªûÊï∏") ||
                offset.merchant.includes("ÂõûÈ•ã");
              if (!isOffsetType) return;

              // Á∞°ÊòìÂêçÁ®±ÊØîÂ∞ç
              const cleanItemName = item.merchant
                .replace(/ÈÄ£Âä†\*/g, "")
                .replace(/\(.*\)/g, "")
                .trim();
              const cleanOffsetName = offset.merchant
                .replace(/ÈªûÊï∏ÊäòÊäµ_?/g, "")
                .replace(/ÊäòÊäµ/g, "")
                .replace(/ÈÄ£Âä†\*/g, "")
                .trim();
              const isNameMatch =
                (cleanItemName.includes(cleanOffsetName) ||
                  cleanOffsetName.includes(cleanItemName)) &&
                cleanOffsetName.length > 2;

              if (isNameMatch) {
                if (Math.abs(offset.amount) <= item.amount) {
                  finalAmount += offset.amount; // offset amount is negative, so this subtracts
                  totalDeduction += Math.abs(offset.amount);
                  usedOffsetIds.add(offset.id);
                  matched = true;
                }
              }
            });

            const note = matched
              ? ` (Â∑≤Êâ£Èô§ÊäòÊäµ $${totalDeduction.toLocaleString()})`
              : "";
            if (finalAmount > 0) {
              mergedItems.push({
                ...item,
                amount: finalAmount,
                merchant: item.merchant + note,
                originalAmount: item.amount, // ‰øùÊåÅÂéüÂßãÈáëÈ°çÔºå‰ª•‰æõÂèÉËÄÉ
              });
            }
          });

          // Âä†ÂÖ•Êú™ÂåπÈÖçÁöÑË≤†È†Ö (Â¶ÇÊûúÊúâÁöÑË©±)
          negativeItems.forEach((offset) => {
            if (!usedOffsetIds.has(offset.id)) {
              mergedItems.push(offset);
            }
          });

          if (mergedItems.length > 0) {
            setQueue((prev) => [...prev, ...mergedItems]);
            setRawInput("");
            setCardNameInput("");
            setShowImportModal(false);
          } else {
            alert("ÁÑ°Ê≥ïË≠òÂà•ÂÖßÂÆπÔºåÊàñÊâÄÊúâÈ†ÖÁõÆÁöÜË¢´ÊäòÊäµÂÆåÁï¢„ÄÇ");
          }
        };

        const handleAddManual = async () => {
          if (
            !manualForm.merchant ||
            !manualForm.amount ||
            isNaN(parseFloat(manualForm.amount))
          ) {
            alert("Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÈ†ÖÁõÆÂêçÁ®±ÂíåÈáëÈ°ç„ÄÇ");
            return;
          }
          const date = new Date()
            .toISOString()
            .split("T")[0]
            .replace(/-/g, "/");
          const item = {
            id: Date.now(),
            date,
            merchant: manualForm.merchant,
            amount: parseFloat(manualForm.amount),
            category: classifyCategory(manualForm.merchant),
            card: "ÁèæÈáë/ÊâãÂãï",
          };
          await handleSwipe(item, manualForm.type);
          setShowManualModal(false);
          setManualForm({ merchant: "", amount: "", type: "shared" });
        };

        // --- Derived Data ---
        const monthlyHistory = useMemo(() => {
          return history.filter((item) => item.monthKey === selectedMonthKey);
        }, [history, selectedMonthKey]);

        const summary = useMemo(() => {
          let personalTotal = 0;
          let sharedTotal = 0;
          let forHimTotal = 0;

          monthlyHistory.forEach((item) => {
            if (item.type === "personal") personalTotal += item.amount;
            if (item.type === "shared") sharedTotal += item.amount;
            if (item.type === "for_him") forHimTotal += item.amount;
          });

          return {
            personalTotal,
            sharedTotal,
            forHimTotal,
            bfOwes: Math.round(sharedTotal / 2 + forHimTotal),
            myShare: Math.round(sharedTotal / 2 + personalTotal),
            monthLabel: selectedMonthKey,
          };
        }, [monthlyHistory, selectedMonthKey]);

        const chartData = useMemo(() => {
          const targetType = chartView === "personal" ? "personal" : "shared";
          const dataMap = {};

          monthlyHistory
            .filter((i) => i.type === targetType && i.amount > 0)
            .forEach((item) => {
              const cat = item.category || "ÂÖ∂‰ªñ";
              dataMap[cat] = (dataMap[cat] || 0) + item.amount;
            });

          return Object.keys(dataMap).map((key) => ({
            name: key,
            value: dataMap[key],
          }));
        }, [monthlyHistory, chartView]);

        // --- Components ---
        const MonthSelector = () => (
          // Fix: 1. Added relative to establish positioning context.
          // Fix: 2. Kept justify-center but ensured select is explicitly opaque (bg-white).
          <div className="flex items-center justify-center space-x-2 bg-white px-4 py-2 rounded-full shadow-sm mb-4 relative">
            <Calendar className="w-4 h-4 text-gray-500" />
            <select
              value={selectedMonthKey}
              onChange={(e) => {
                setSelectedMonthKey(e.target.value);
                setAiInsight("");
              }}
              // ‰øÆÊ≠£ÔºöÂæû bg-transparent ÊîπÁÇ∫ bg-whiteÔºåÈÅøÂÖç iOS ÈÅ∏ÊìáÂô®ÂÆö‰ΩçÈåØË™§
              className="bg-white text-sm font-bold text-gray-700 focus:outline-none"
            >
              {availableMonths.map((m) => (
                <option key={m} value={m}>
                  {m}
                </option>
              ))}
            </select>
          </div>
        );

        const TabButton = ({ id, icon: Icon, label }) => (
          <button
            onClick={() => setActiveTab(id)}
            className={`flex flex-col items-center justify-center w-full py-2 transition-colors ${
              activeTab === id ? "text-blue-500" : "text-gray-400"
            }`}
          >
            <Icon className="w-6 h-6" />
            <span className="text-[10px] mt-1 font-medium">{label}</span>
          </button>
        );

        if (!user) {
          return (
            <div className="flex flex-col h-screen w-full items-center justify-center bg-gray-50">
              <Loader className="w-8 h-8 animate-spin text-blue-500 mb-2" />
              <p className="text-gray-500 text-sm">Ê≠£Âú®ÈÄ£Á∑öËá≥Ë≥áÊñôÂ∫´...</p>
            </div>
          );
        }

        return (
          <div className="flex flex-col h-screen w-full max-w-md mx-auto bg-[#F2F2F7] overflow-hidden font-sans text-slate-900 relative">
            {/* Navbar */}
            <div className="bg-white/80 backdrop-blur-md border-b border-gray-200 pt-10 pb-3 px-4 flex justify-between items-center z-20 sticky top-0">
              <h1 className="text-xl font-bold">
                {activeTab === "swipe" && "Â∏≥ÂñÆÂàÜÈ°û"}
                {activeTab === "summary" && "ÁµêÁÆóÊòéÁ¥∞"}
                {activeTab === "analysis" && "Ëä±Ë≤ªÂàÜÊûê"}
              </h1>
              <div className="flex gap-3">
                {activeTab === "swipe" && (
                  <>
                    <button
                      onClick={() => setShowImportModal(true)}
                      className="text-blue-500 flex items-center gap-1"
                    >
                      <FileText className="w-5 h-5" />
                      <span className="text-sm font-medium">ÂåØÂÖ•</span>
                    </button>
                    <button
                      onClick={() => setShowManualModal(true)}
                      className="text-blue-500"
                    >
                      <Plus className="w-6 h-6" />
                    </button>
                  </>
                )}
              </div>
            </div>

            {/* Content */}
            <div className="flex-1 overflow-y-auto overflow-x-hidden relative p-4 no-scrollbar">
              {/* SWIPE TAB */}
              {activeTab === "swipe" && (
                <div className="h-full flex flex-col items-center justify-center -mt-4">
                  {queue.length > 0 ? (
                    <div className="w-full max-w-xs relative h-[420px]">
                      <div className="absolute top-4 left-4 w-full h-full bg-white rounded-3xl shadow-sm border border-gray-200 opacity-50 transform scale-95 translate-y-2"></div>

                      <div className="absolute top-0 left-0 w-full h-full bg-white rounded-3xl shadow-xl border border-gray-100 flex flex-col items-center justify-between p-6 z-10 transition-all duration-300">
                        <div className="w-full flex justify-between items-center text-gray-400 text-sm font-medium uppercase tracking-wider">
                          <span>{queue[0].card}</span>
                          <span>{queue[0].date}</span>
                        </div>

                        <div className="flex-1 flex flex-col items-center justify-center text-center w-full">
                          <div className="w-16 h-16 rounded-full bg-blue-50 flex items-center justify-center mb-4 text-3xl">
                            {queue[0].merchant.includes("Uber")
                              ? "üçî"
                              : queue[0].category === "‰∫§ÈÄö"
                              ? "üöÑ"
                              : queue[0].category === "Â±ÖÂÆ∂"
                              ? "üè†"
                              : "üßæ"}
                          </div>
                          <h2 className="text-xl font-bold text-gray-800 mb-2 line-clamp-3 leading-tight break-words w-full px-2">
                            {queue[0].merchant}
                          </h2>
                          {queue[0].amount < 0 ? (
                            <span className="text-red-500 text-sm bg-red-50 px-3 py-1 rounded-full font-bold">
                              ÈÄÄÊ¨æ / Ë≤†È†Ö
                            </span>
                          ) : (
                            <span className="text-blue-500 text-xs bg-blue-50 px-3 py-1 rounded-full font-bold">
                              {queue[0].category}
                            </span>
                          )}
                        </div>

                        <div className="mb-8">
                          <span
                            className={`text-4xl font-bold ${
                              queue[0].amount < 0
                                ? "text-green-600"
                                : "text-slate-900"
                            }`}
                          >
                            ${queue[0].amount.toLocaleString()}
                          </span>
                        </div>

                        <div className="w-full grid grid-cols-3 gap-3">
                          <button
                            onClick={() => handleSwipe(queue[0], "personal")}
                            className="flex flex-col items-center justify-center py-3 rounded-2xl bg-red-50 text-red-500 hover:bg-red-100 transition active:scale-95"
                          >
                            <User className="w-6 h-6 mb-1" />
                            <span className="text-xs font-bold">ÂÄã‰∫∫</span>
                          </button>
                          <button
                            onClick={() => handleSwipe(queue[0], "for_him")}
                            className="flex flex-col items-center justify-center py-3 rounded-2xl bg-purple-50 text-purple-600 hover:bg-purple-100 transition active:scale-95"
                          >
                            <ArrowLeftRight className="w-6 h-6 mb-1" />
                            <span className="text-xs font-bold">‰ª£Â¢ä</span>
                          </button>
                          <button
                            onClick={() => handleSwipe(queue[0], "shared")}
                            className="flex flex-col items-center justify-center py-3 rounded-2xl bg-green-50 text-green-500 hover:bg-green-100 transition active:scale-95"
                          >
                            <Users className="w-6 h-6 mb-1" />
                            <span className="text-xs font-bold">ÂÖ±Âêå</span>
                          </button>
                        </div>
                      </div>
                    </div>
                  ) : (
                    <div className="text-center p-10 bg-white rounded-3xl shadow-sm">
                      <div className="bg-green-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600">
                        <Check className="w-10 h-10" />
                      </div>
                      <h3 className="text-xl font-bold text-gray-800 mb-2">
                        ÂÖ®ÈÉ®ÂàÜÈ°ûÂÆåÁï¢ÔºÅ
                      </h3>
                      <p className="text-gray-500">
                        ÊÇ®ÂèØ‰ª•ÊâãÂãïÊñ∞Â¢ûÊàñÂæûÁµêÁÆóÈ†ÅÈù¢Êü•ÁúãË©≥Á¥∞Ë≥áÊñô„ÄÇ
                      </p>
                    </div>
                  )}
                </div>
              )}

              {/* SUMMARY TAB */}
              {activeTab === "summary" && (
                <div className="space-y-4 pb-20">
                  <MonthSelector />

                  <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-3xl p-6 text-white shadow-lg shadow-blue-200 relative overflow-hidden">
                    {/* Gemini AI Message Button */}
                    <button
                      onClick={generateSettlementMessage}
                      className="absolute top-4 right-4 bg-white/20 hover:bg-white/30 p-2 rounded-full transition backdrop-blur-sm"
                      title="AI Áî¢ÁîüË´ãÊ¨æË®äÊÅØ"
                    >
                      <Sparkles className="w-5 h-5 text-yellow-300" />
                    </button>

                    <div className="flex items-center justify-between mb-2">
                      <span className="text-blue-100 font-medium text-sm">
                        Áî∑ÂèãÊáâ‰ªòÁ∏ΩÈ°ç
                      </span>
                      <Heart className="w-5 h-5 text-blue-200 fill-blue-200" />
                    </div>
                    <div className="text-4xl font-bold mb-6">
                      ${summary.bfOwes.toLocaleString()}
                    </div>

                    <div className="grid grid-cols-2 gap-4 border-t border-white/20 pt-4">
                      <div>
                        <span className="text-xs text-blue-100 block mb-1">
                          ÂÖ±ÂêåËä±Ë≤ª (Ê∑®È°ç)
                        </span>
                        <span className="text-lg font-semibold">
                          ${summary.sharedTotal.toLocaleString()}
                        </span>
                        <div className="text-[10px] text-blue-200 mt-0.5">
                          ‰∏Ä‰∫∫ $
                          {Math.round(summary.sharedTotal / 2).toLocaleString()}
                        </div>
                      </div>
                      <div>
                        <span className="text-xs text-blue-100 block mb-1">
                          Â¶≥Âπ´‰ªñ‰ª£Â¢ä
                        </span>
                        <span className="text-lg font-semibold">
                          ${summary.forHimTotal.toLocaleString()}
                        </span>
                      </div>
                    </div>
                  </div>

                  <div className="bg-white rounded-2xl shadow-sm overflow-hidden">
                    <div className="px-4 py-3 border-b border-gray-100 flex justify-between items-center">
                      <h3 className="font-bold text-gray-800">ÂàÜÈ°ûÊòéÁ¥∞</h3>
                      <span className="text-xs text-gray-400">
                        {monthlyHistory.length} Á≠ÜË≥áÊñô
                      </span>
                    </div>
                    <div className="divide-y divide-gray-100">
                      {monthlyHistory.map((item) => (
                        <div
                          key={item.id}
                          className="flex justify-between items-center p-4 group"
                        >
                          <div className="flex items-center gap-3 overflow-hidden flex-1">
                            <div
                              className={`w-2 h-10 shrink-0 rounded-full ${
                                item.type === "personal"
                                  ? "bg-red-400"
                                  : item.type === "shared"
                                  ? "bg-green-400"
                                  : "bg-purple-400"
                              }`}
                            ></div>
                            <div className="min-w-0 flex-1">
                              <div
                                className="font-medium text-gray-900 truncate text-sm"
                                title={item.merchant}
                              >
                                {item.merchant}
                              </div>
                              <div className="text-xs text-gray-400 mt-0.5">
                                {item.date} ¬∑ {item.card}
                              </div>
                            </div>
                          </div>
                          <div className="text-right flex items-center gap-3">
                            <div>
                              <div className="font-bold text-gray-900">
                                ${item.amount.toLocaleString()}
                              </div>
                              <div
                                className={`text-[10px] px-2 py-0.5 rounded-md inline-block mt-1 ${
                                  item.type === "personal"
                                    ? "bg-red-50 text-red-500"
                                    : item.type === "shared"
                                    ? "bg-green-50 text-green-500"
                                    : "bg-purple-50 text-purple-500"
                                }`}
                              >
                                {item.type === "personal"
                                  ? "ÂÄã‰∫∫"
                                  : item.type === "shared"
                                  ? "ÂÖ±Âêå"
                                  : "‰ª£Â¢ä"}
                              </div>
                            </div>
                            <button
                              // ‰øÆÊ≠£Ôºö‰ΩøÁî®Ëá™ÂÆöÁæ© modal ÊõøÊèõ confirm()Ôºå‰ΩÜÁÇ∫‰øùÊåÅÂñÆÊ™îÊ°àÁ∞°ÂñÆÊÄßÔºå‰ΩøÁî® window.confirm
                              onClick={() => handleDelete(item.id)}
                              className="p-2 text-gray-300 hover:text-red-500 hover:bg-red-50 rounded-full transition"
                            >
                              <Trash2 className="w-4 h-4" />
                            </button>
                          </div>
                        </div>
                      ))}
                      {monthlyHistory.length === 0 && (
                        <div className="p-8 text-center text-gray-400 text-sm">
                          Ê≠§Êúà‰ªΩÂ∞öÁÑ°Ë≥áÊñô
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              )}

              {/* ANALYSIS TAB */}
              {activeTab === "analysis" && (
                <div className="space-y-4 pb-20">
                  <MonthSelector />

                  <div className="w-full bg-white p-1 rounded-xl flex shadow-sm">
                    <button
                      className={`flex-1 text-center py-2 text-sm font-medium rounded-lg transition ${
                        chartView === "personal"
                          ? "bg-blue-500 text-white"
                          : "text-gray-500 hover:bg-gray-50"
                      }`}
                      onClick={() => setChartView("personal")}
                    >
                      ÂÄã‰∫∫Ëä±Ë≤ª
                    </button>
                    <button
                      className={`flex-1 text-center py-2 text-sm font-medium rounded-lg transition ${
                        chartView === "shared"
                          ? "bg-green-500 text-white"
                          : "text-gray-500 hover:bg-gray-50"
                      }`}
                      onClick={() => setChartView("shared")}
                    >
                      ÂÖ±ÂêåËä±Ë≤ª
                    </button>
                  </div>

                  <div className="bg-white rounded-2xl p-6 shadow-sm relative">
                    <div className="flex justify-between items-center mb-6">
                      <h3 className="font-bold text-gray-800 text-center flex-1">
                        {chartView === "personal" ? "ÂÄã‰∫∫" : "ÂÖ±Âêå"}Ëä±Ë≤ªÈ°ûÂà• (
                        {selectedMonthKey})
                      </h3>
                      {/* AI Insight Button */}
                      {chartData.length > 0 && (
                        <button
                          onClick={generateInsight}
                          disabled={isInsightLoading}
                          className="absolute right-4 top-4 text-purple-600 hover:bg-purple-50 p-2 rounded-full transition"
                          title="AI Ê∂àË≤ªÂàÜÊûê"
                        >
                          {isInsightLoading ? (
                            <Loader className="w-5 h-5 animate-spin" />
                          ) : (
                            <Wand2 className="w-5 h-5" />
                          )}
                        </button>
                      )}
                    </div>

                    {/* AI Insight Result */}
                    {aiInsight && (
                      <div className="mb-6 bg-purple-50 p-3 rounded-xl text-sm text-purple-800 border border-purple-100 animate-in fade-in slide-in-from-top-2">
                        <div className="flex items-start gap-2">
                          <Sparkles className="w-4 h-4 shrink-0 mt-0.5" />
                          <p>{aiInsight}</p>
                        </div>
                      </div>
                    )}

                    <div className="h-[250px] w-full">
                      {/* ÂÉÖÂú® Recharts Ê®°ÁµÑÂíåË≥áÊñôÈÉΩÊ∫ñÂÇôÂ•ΩÊôÇÊâçÊ∏≤ÊüìÂúñË°® */}
                      {isRechartsReady && chartData.length > 0 ? (
                        <ResponsiveContainer width="100%" height="100%">
                          <PieChart>
                            <Pie
                              data={chartData}
                              cx="50%"
                              cy="50%"
                              innerRadius={60}
                              outerRadius={80}
                              paddingAngle={5}
                              dataKey="value"
                            >
                              {chartData.map((entry, index) => (
                                <Cell
                                  key={`cell-${index}`}
                                  fill={PIE_COLORS[index % PIE_COLORS.length]}
                                />
                              ))}
                            </Pie>
                            <Tooltip
                              formatter={(value) =>
                                `$${value.toLocaleString()}`
                              }
                            />
                            <Legend />
                          </PieChart>
                        </ResponsiveContainer>
                      ) : (
                        <div className="h-full flex items-center justify-center text-gray-400">
                          {isRechartsReady ? "ÁÑ°Êï∏Êìö" : "ÂúñË°®ÁµÑ‰ª∂ËºâÂÖ•‰∏≠..."}
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              )}
            </div>

            {/* Footer Nav */}
            <div className="bg-white/90 backdrop-blur-lg border-t border-gray-200 pb-safe pt-1 px-2 flex justify-around items-center z-20 shrink-0">
              <TabButton id="swipe" icon={CreditCard} label="ÂàÜÈ°û" />
              <TabButton id="summary" icon={Wallet} label="ÁµêÁÆó" />
              <TabButton id="analysis" icon={PieIcon} label="ÂàÜÊûê" />
            </div>

            {/* Import Modal */}
            {showImportModal && (
              <div className="absolute inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-end sm:items-center justify-center">
                <div className="bg-white w-full sm:w-10/12 max-w-sm rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl animate-in slide-in-from-bottom duration-300 flex flex-col max-h-[90%]">
                  <div className="flex justify-between items-center mb-4 shrink-0">
                    <h3 className="font-bold text-lg">ÂåØÂÖ•Â∏≥ÂñÆÊòéÁ¥∞</h3>
                    <button
                      onClick={() => setShowImportModal(false)}
                      className="p-1 bg-gray-100 rounded-full"
                    >
                      <X className="w-5 h-5" />
                    </button>
                  </div>

                  <div className="mb-4 shrink-0">
                    <label className="text-xs font-bold text-gray-500 ml-1">
                      Âç°ÁâáÂêçÁ®±
                    </label>
                    <input
                      type="text"
                      className="w-full mt-1 p-3 bg-gray-50 rounded-xl border-none focus:ring-2 focus:ring-blue-500 text-sm"
                      placeholder="‰æãÂ¶ÇÔºöÂè∞Êñ∞ÁãóÁãóÂç°"
                      value={cardNameInput}
                      onChange={(e) => setCardNameInput(e.target.value)}
                    />
                  </div>

                  <p className="text-sm text-gray-500 mb-3 shrink-0">
                    Ë´ãË≤º‰∏äÁ∂≤ÈäÄÊòéÁ¥∞„ÄÇÊô∫ÊÖßÁ≥ªÁµ±ÊúÉËá™ÂãïÂêà‰Ωµ„ÄåÊäòÊäµ„ÄçÈ†ÖÁõÆÔºåÂÉÖÈ°ØÁ§∫Ê∑®È°ç„ÄÇ
                  </p>
                  <textarea
                    className="w-full flex-1 min-h-[150px] p-3 bg-gray-50 rounded-xl border-none text-xs focus:ring-2 focus:ring-blue-500 font-mono"
                    placeholder={`Ë´ãË≤º‰∏äÊòéÁ¥∞ÊñáÂ≠ó...`}
                    value={rawInput}
                    onChange={(e) => setRawInput(e.target.value)}
                  />
                  <button
                    onClick={parseBillText}
                    className="w-full mt-4 bg-blue-600 text-white py-3 rounded-xl font-bold text-sm hover:bg-blue-700 transition shrink-0"
                  >
                    Êô∫ÊÖßËß£ÊûêÂåØÂÖ•
                  </button>
                </div>
              </div>
            )}

            {/* AI Message Modal */}
            {showAiModal && (
              <div className="absolute inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-end sm:items-center justify-center">
                <div className="bg-white w-full sm:w-10/12 max-w-sm rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl animate-in slide-in-from-bottom duration-300">
                  <div className="flex justify-between items-center mb-4">
                    <div className="flex items-center gap-2">
                      <Sparkles className="w-5 h-5 text-yellow-500" />
                      <h3 className="font-bold text-lg">AI ÊííÂ¨åË´ãÊ¨æÂñÆ</h3>
                    </div>
                    <button
                      onClick={() => setShowAiModal(false)}
                      className="p-1 bg-gray-100 rounded-full"
                    >
                      <X className="w-5 h-5" />
                    </button>
                  </div>

                  <div className="bg-yellow-50 p-4 rounded-xl text-sm text-gray-800 leading-relaxed mb-4 min-h-[100px] whitespace-pre-wrap font-medium">
                    {isAiLoading ? (
                      <div className="flex flex-col items-center justify-center h-24 text-gray-400 gap-2">
                        <Loader className="w-6 h-6 animate-spin text-yellow-500" />
                        <span>Ê≠£Âú®ÈÜûÈáÄÂèØÊÑõË™ûÊ∞£...</span>
                      </div>
                    ) : (
                      aiMessage
                    )}
                  </div>

                  <div className="flex gap-3">
                    <button
                      onClick={generateSettlementMessage}
                      disabled={isAiLoading}
                      className="flex-1 py-3 rounded-xl font-bold text-sm bg-gray-100 text-gray-600 hover:bg-gray-200 transition"
                    >
                      ÊèõÂÄãË™ûÊ∞£
                    </button>
                    <button
                      onClick={() => copyToClipboard(aiMessage)}
                      disabled={isAiLoading || !aiMessage}
                      className="flex-1 py-3 rounded-xl font-bold text-sm bg-black text-white hover:bg-gray-800 transition flex items-center justify-center gap-2"
                    >
                      <Copy className="w-4 h-4" />
                      Ë§áË£ΩË®äÊÅØ
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* Manual Modal */}
            {showManualModal && (
              <div className="absolute inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-end sm:items-center justify-center">
                <div className="bg-white w-full sm:w-10/12 max-w-sm rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl animate-in slide-in-from-bottom duration-300">
                  <div className="flex justify-between items-center mb-6">
                    <h3 className="font-bold text-lg">Êñ∞Â¢ûÊâãÂãïËä±Ë≤ª</h3>
                    <button
                      onClick={() => setShowManualModal(false)}
                      className="p-1 bg-gray-100 rounded-full"
                    >
                      <X className="w-5 h-5" />
                    </button>
                  </div>

                  <div className="space-y-4">
                    <div>
                      <label className="text-xs font-bold text-gray-500 ml-1">
                        È†ÖÁõÆÂêçÁ®±
                      </label>
                      <input
                        type="text"
                        className="w-full mt-1 p-3 bg-gray-50 rounded-xl border-none focus:ring-2 focus:ring-blue-500"
                        placeholder="‰æãÂ¶ÇÔºöË∑ØÈÇäÊî§ÊôöÈ§ê"
                        value={manualForm.merchant}
                        onChange={(e) =>
                          setManualForm({
                            ...manualForm,
                            merchant: e.target.value,
                          })
                        }
                      />
                    </div>
                    <div>
                      <label className="text-xs font-bold text-gray-500 ml-1">
                        ÈáëÈ°ç
                      </label>
                      <input
                        type="number"
                        className="w-full mt-1 p-3 bg-gray-50 rounded-xl border-none focus:ring-2 focus:ring-blue-500 text-lg font-bold"
                        placeholder="0"
                        value={manualForm.amount}
                        onChange={(e) =>
                          setManualForm({
                            ...manualForm,
                            amount: e.target.value,
                          })
                        }
                      />
                    </div>
                    <div>
                      <label className="text-xs font-bold text-gray-500 ml-1">
                        ÂàÜÈ°û
                      </label>
                      <div className="grid grid-cols-3 gap-2 mt-1">
                        <button
                          onClick={() =>
                            setManualForm({ ...manualForm, type: "personal" })
                          }
                          className={`py-2 rounded-lg text-xs font-bold border transition ${
                            manualForm.type === "personal"
                              ? "bg-red-50 border-red-200 text-red-600"
                              : "border-gray-100 text-gray-400"
                          }`}
                        >
                          ÂÄã‰∫∫
                        </button>
                        <button
                          onClick={() =>
                            setManualForm({ ...manualForm, type: "shared" })
                          }
                          className={`py-2 rounded-lg text-xs font-bold border transition ${
                            manualForm.type === "shared"
                              ? "bg-green-50 border-green-200 text-green-600"
                              : "border-gray-100 text-gray-400"
                          }`}
                        >
                          ÂÖ±Âêå
                        </button>
                        <button
                          onClick={() =>
                            setManualForm({ ...manualForm, type: "for_him" })
                          }
                          className={`py-2 rounded-lg text-xs font-bold border transition ${
                            manualForm.type === "for_him"
                              ? "bg-purple-50 border-purple-200 text-purple-600"
                              : "border-gray-100 text-gray-400"
                          }`}
                        >
                          ‰ª£Â¢ä
                        </button>
                      </div>
                    </div>
                  </div>

                  <button
                    onClick={handleAddManual}
                    className="w-full mt-8 bg-black text-white py-3 rounded-xl font-bold text-sm hover:bg-gray-800 transition shadow-lg"
                  >
                    Âä†ÂÖ•Â∏≥ÂñÆ
                  </button>
                </div>
              </div>
            )}
          </div>
        );
      }

      // Ê∏≤Êüì App
      const container = document.getElementById("root");
      const root = ReactDOM.createRoot(container);
      root.render(<ExpenseSplitterApp />);
    </script>
  </body>
</html>
